<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>KoiBoi</title>
    <link rel="icon" href="favicon.png" />
    <script src="phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>
<script type="text/javascript">
const config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
        default: 'arcade',
        arcade: {
            gravity: 0
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };
    var keys;
    var camera;
    var koi;
    var padGroup;
    var bugs;
    var bugsText;
    var bugsCount = 0;
    const game = new Phaser.Game(config);

     function preload () {
        this.load.image('pond', 'assets/png/pondbottom.png');
        this.load.spritesheet('koiboi', 'assets/png/spritesheet.png',
        /*{frameWidth: 87, frameHeight: 113}*/ 
        {frameWidth: 113, frameHeight: 87});
        this.load.image('land1', 'assets/png/pondedgeleft.png');
        this.load.image('land2', 'assets/png/pondedgeright.png');
        this.load.image('pad1', 'assets/png/pads/pad01.png');
        this.load.image('pad2', 'assets/png/pads/pad02.png');
        this.load.image('pad3', 'assets/png/pads/pad03.png');
        this.load.image('pad4', 'assets/png/pads/pad04.png');
        this.load.image('dragon', 'assets/png/bugs/dragonfly.png');
        this.load.image('spidey', 'assets/png/bugs/waterspider.png');
        this.load.image('fly', 'assets/png/bugs/fly.png');
        this.load.image('worm', 'assets/png/bugs/worm.png')
     }

     function create () {

        //set up world bounds, camera and movement input
        this.physics.world.setBounds(50, -500, 350 * 2, 500 * 2);
        this.cameras.main.setBounds(0, -500, 350 * 2, 500 * 2);
        keys = this.input.keyboard.createCursorKeys();

        //add background image(s)
        this.add.image(0, -500, 'pond').setFlipX(true).setOrigin(0);
        this.add.image(400, -500, 'pond').setFlipX(true).setOrigin(0);
        this.add.image(0, 0, 'pond').setOrigin(0);
        this.add.image(400, 0, 'pond').setOrigin(0);
        
        //add and set up sprite
        this.player = this.physics.add.sprite(400, 450, 'koiboi');
        koi = this.player;
        koi.angle = -90;
        //koi.body.setSize(40, 113).setOffset(0, 0);
        koi.body.enable = true;
        koi.body.setCircle(true);
        //koi.setScale(1);
        koi.body.collideWorldBounds = true;
        koi.anchor = 0.1, 0.1;
        
        this.cameras.main.startFollow(koi, true);
        
        this.anims.create({
            key: 'swim',
            frames: this.anims.generateFrameNumbers('koiboi', 
            { frames: [ 0, 1, 2, 3, 4, 5, 6, 7 ] }),
            frameRate: 8,
            repeat: -1
        });

        //add a semi-transparent layer to mimic water surface
        this.add.rectangle(400, 0, 800, 1000, 0x99d9ea, 0.4);

        //add ornamental edges (accounted for in world bounds)
        this.add.image(200, 250, 'land1');
        this.add.image(200, -250, 'land1');
        this.add.image(600, 250, 'land2');
        this.add.image(600, -250, 'land2');

        //add collison elements at random points in rows,

        function getX () {
            for (var i = 0; i < 10; i++) {
                var x = Phaser.Math.Between(100, 700);
                return x;
            }
        };

        padGroup = this.physics.add.staticGroup({
            key: ['pad1', 'pad2', 'pad3', 'pad4'],
            frameQuantity: 10,
            
        });

        var pads = padGroup.getChildren();

        for (var i = 0; i < pads.length; i++) {
            var x = Phaser.Math.Between(100, 700);
            var y = Phaser.Math.Between(300, -350);

            pads[i].setPosition(x, y);
            
        }

        padGroup.refresh();

        this.physics.add.collider(koi, padGroup)
        /*pads.create(getX(), 300, 'pad1');
        pads.create(getX(), 300, 'pad2');
        pads.create(getX(), 300, 'pad3');
        pads.create(getX(), 300, 'pad4');
        pads.create(getX(), 225, 'pad1');
        pads.create(getX(), 225, 'pad2');
        pads.create(getX(), 225, 'pad3');
        pads.create(getX(), 225, 'pad4');*/


        //add collectable elements
        bugsGroup = this.physics.add.staticGroup({
            key: ['dragon', 'spidey', 'fly'],
            frameQuantity: 4,
            immovable: true
        });

        const bugs = bugsGroup.getChildren();

        for (var i = 0; i < bugs.length; i++)
        {
            var x = Phaser.Math.Between(100, 700);
            var y = Phaser.Math.Between(350, -500);

            bugs[i].setPosition(x, y).setSize(20, 20);
        }

        bugsGroup.refresh();

        this.physics.add.collider(koi, bugsGroup, bugHit);
        bugsCount = bugs.length;
        bugsText = this.add.text(100, 20, 'Bugs left: ' + bugsCount, {
            font: 'bold 32px Courier',
            fill: '#FFFFFF',
        });
        bugsText.scrollFactorX = 0;
        bugsText.scrollFactorY = 0;

        //debugging
        graphics = this.add.graphics();
        
     }

    function bugHit (koi, bug) {
        bugsGroup.killAndHide(bug);
        bug.body.enable = false;
        bugsCount -= 1;
     }

    function update () {
        bugsText.setText('Bugs left: ' + bugsCount);

        koi.setVelocity(0);
        koi.setAngularVelocity(0);

        if (keys.right.isDown) {
            koi.setAngularVelocity(200)
            koi.play('swim', true)
        } else if (keys.left.isDown) {
            koi.setAngularVelocity(-200)
            koi.play('swim', true)
        } else if (keys.up.isDown) {
            this.physics.velocityFromAngle(koi.angle, 200, koi.body.velocity);
            koi.play('swim', true)
        } else if(keys.down.isDown) {
            this.physics.velocityFromAngle(koi.angle, -200, koi.body.velocity);
            koi.play('swim', true)
        } else {
            koi.stop();
            koi.setFrame(3)
        }

        //debugging
        var koiBounds = koi.getBounds();
        var bugBounds = [];
        bugsGroup.children.iterate((child) => {
            var bounds = child.getBounds();
            bugBounds.push(bounds);
        })
        var padBounds = [];
        padGroup.children.iterate((child) => {
            var bounds = child.getBounds();
            padBounds.push(bounds);
        })

        graphics.clear();

        graphics.lineStyle(1, 0xFF0000);
        graphics.strokeRectShape(koiBounds);

        for (var i = 0; i < bugBounds.length; i++) {
            graphics.lineStyle(1, 0x0000FF);
            graphics.strokeRectShape(bugBounds[i]);
        }

        for (var i = 0; i < padBounds.length; i++) {
            graphics.lineStyle(1, 0x00FF00);
            graphics.strokeRectShape(padBounds[i]);
        }
    }


</script>
</body>
</html>